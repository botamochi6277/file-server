<!DOCTYPE html>
<html lang="en">

<head>
  <title>Explorer | {directory}</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@mui/material@latest/umd/material-ui.development.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />

  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- <script
      src="https://cdn.jsdelivr.net/npm/@acidic9/pure-react-carousel@0.0.0-semantically-released/dist/index.cjs.min.js"
      crossorigin="anonymous"
    ></script> -->
  <style>
    .MuiCard-root {
      margin: 1em;
    }
  </style>
</head>
<!-- https://cpoint-lab.co.jp/article/202204/22592/ -->

<body class="directory">
  <div class="myapp">
    <div class="dark-switch"></div>
    <div class="preview-card"></div>
    <div class="files-card"></div>
  </div>
  <script type="text/babel">
    'use strict'

    const parsePath = (s) => {
      const path_arr = s.split('/')
      const basename = path_arr[path_arr.length - 1]
      const b = basename.split('.')
      return ({
        dirname: path_arr.length === 1 ? '' : path_arr[path_arr.length - 2],
        basename: basename,
        file_format: (b.length === 1 || s === '..') ? 'folder' : b[b.length - 1].length < 8 ? b[b.length - 1] : 'folder',
      })
    }

    const mediaType = (file_format) => {
      // component="video, audio, picture, iframe, or img".
      const img_found = ['jpeg', 'jpg', 'png', 'webp', 'ico', 'gif', 'heic'].find(
        (e) => e === file_format,
      )
      if (img_found) {
        return 'img'
      }

      const video_found = ['mp4', 'wmv', 'mkv', 'webm'].find(
        (e) => e === file_format,
      )
      if (video_found) {
        return 'video'
      }

      const audio_found = ['mp3', 'wav'].find(
        (e) => e === file_format,
      )
      if (audio_found) {
        return 'audio'
      }
      const txt_found = ['md', 'txt'].find(
        (e) => e === file_format,
      )
      if (txt_found) {
        return 'iframe'
      }
      return ''
    }


    const Icon = (props) => {
      return <span class="material-symbols-outlined">{props.icon}</span>
    }

    const MediaIcon = (props) => {

      if (props.file_format === 'folder') {
        return (<Icon icon='folder' />)
      }
      const media = mediaType(props.file_format)

      if (media === 'img') {
        return (<Icon icon='image' />)
      }
      if (media === 'video') {
        return (<Icon icon='movie' />)
      }
      if (media === 'iframe') {
        return (<Icon icon='article' />)
      }

      if (media === 'audio') {
        return (<Icon icon='audio_file' />)
      }

      return (<Icon icon='file_open' />)
    }

    const useWindowSize = () => {
      const [size, setSize] = React.useState([0, 0]);
      React.useLayoutEffect(() => {
        const updateSize = () => {
          setSize([window.innerWidth, window.innerHeight]);
        };

        window.addEventListener('resize', updateSize);
        updateSize();

        return () => window.removeEventListener('resize', updateSize);
      }, []);
      // console.log(`window-size: ${size}`)
      return size;
    };
    const GetWindowSizeComponent = () => {
      const [width, height] = useWindowSize();

      return (
        <span>
          {`${width} x ${height}`}
        </span>
      );
    };

    const FilesCard = (props) => {

      const src_list = props.sources;

      const filesizeFormat = (size) => {
        if (size === "") {
          return ""
        }
        const number_size = Number(size);
        if (number_size > 1e9) {
          return `${(number_size / 1e9).toFixed(2)} GB`
        }
        if (number_size > 1e6) {
          return `${(number_size / 1e6).toFixed(2)} MB`
        }
        if (number_size > 1e3) {
          return `${(number_size / 1e3).toFixed(2)} KB`
        }
        return `${number_size} B`
      }

      const filenameFormat = (name) => {
        const max_length = 64;
        if (name.length <= max_length) {
          return name;
        }
        return `${name.slice(0, 30)}...${name.slice(-30)}`
      }

      const file_items = src_list.map(
        (a) => {
          return {
            name: a.name,
            href: a.href,
            size: a.size,
            date: a.date
          }
        }
      );
      // console.log(`file: ${file_items[2].name},  ${file_items[2].href}`)
      const {
        Card,
        Typography,
        CardContent,
        Link,
        TableContainer, Table, TableHead, TableRow, TableBody, TableCell,
        Paper
      } = MaterialUI
      const items = file_items.map(f => {
        return (
          <TableRow
            key={f.name}
            sx={{ '&:last-child td, &:last-child th': { border: 0 } }}
          >
            <TableCell component="th" scope="row" align="center">
              <MediaIcon file_format={parsePath(f.name).file_format} />
            </TableCell>
            <TableCell align="left">
              <Link href={f.href}>{f.name}</Link> </TableCell>
            <TableCell align="right">{f.size}</TableCell>
            <TableCell align="left">{f.date}</TableCell>
          </TableRow>
        )
      });


      return (
        <Card>
          <CardContent>
            <Table sx={{ minWidth: 650 }} size="small" aria-label="simple table">
              <TableHead>
                <TableRow>
                  <TableCell align="center">Icon</TableCell>
                  <TableCell align="left">Name</TableCell>
                  <TableCell align="right">Size</TableCell>
                  <TableCell align="left">Date</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {items}
              </TableBody>
            </Table>
          </CardContent>
        </Card>
      )
    }

    class PreviewCard extends React.Component {
      constructor(props) {
        super(props)
        window.addEventListener('resize', this.updateWindowSize);

        const src_list = props.sources;
        const min_idx = src_list[0].title === '..' ? 1 : 0
        // http:, /, /, xxx

        const path_arr = src_list[min_idx].href.split('/')//array of path
        const basename = path_arr[path_arr.length - 1]
        const b = basename.split('.')
        const preview_src = ''
        this.state = {
          src_list: src_list,
          basename: basename,
          min_idx: min_idx,
          idx: min_idx,//initial index
          num_files: src_list.length - min_idx,
          file_format: b[b.length - 1],
          window_size: [window.innerWidth, window.innerHeight]
        }
      }

      updateWindowSize = () => {
        this.setState(
          { window_size: [window.innerWidth, window.innerHeight] }
        );
      }


      previewSrc = () => {
        if (this.mediaType() === "img") {
          return this.state.src_list[this.state.idx].href
        } else {
          return `https://dummyimage.com/600x100/a0a0a0/f7f7f7.png&text=${this.state.basename}`
        }

      }

      idxUpdate = (i) => {
        const p = parsePath(this.state.src_list[i].href)
        this.setState({
          idx: i,
          basename: p.basename,
          file_format: p.file_format,
        })
      }

      onClickNextButton = () => {
        let idx = this.state.idx + 1
        if (idx >= this.state.src_list.length) {
          idx = this.state.min_idx
        }
        this.idxUpdate(idx)
      }
      onClickPrevButton = () => {
        let idx = this.state.idx - 1
        if (idx < this.state.min_idx) {
          idx = this.state.src_list.length - 1
        }
        this.idxUpdate(idx)
      }



      render() {
        const {
          Typography,
          Card, CardMedia, CardHeader, CardContent,
          Button, IconButton, Chip, Stack, Avatar, Badge, Backdrop
        } = MaterialUI
        // const [width, height] = useWindowSize();
        // console.log(` window.innerHeight: ${this.state.window_size[1]}`)
        return (
          <Card>
            <CardHeader
              avatar={
                <Badge
                  badgeContent={`${this.state.idx + (1 - this.state.min_idx)}/${this.state.num_files}`}
                  color="secondary">
                  <Avatar variant='primary' aria-label="recipe">
                    <MediaIcon file_format={this.state.file_format} />
                  </Avatar></Badge>
              }
              title='{directory}'
              subheader={decodeURI(this.state.basename)}
              action={
                <IconButton aria-label="settings" href={this.state.src_list[0].href}>
                  <Icon icon="drive_folder_upload" />
                </IconButton>
              }
            />

            <CardMedia
              sx={{ maxHeight: 0.8 * this.state.window_size[1], objectFit: "scale-down" }}
              src={this.state.src_list[this.state.idx].href}
              component={mediaType(this.state.file_format)}
              title={this.state.src_list[this.state.idx].href}
            // autoPlay
            // loop
            // https://mui.com/material-ui/react-stepper/
            />

            <CardContent>
              <Stack direction="row" spacing={2}>
                <Button
                  variant="contained"
                  onClick={this.onClickPrevButton}
                  startIcon={<Icon icon="navigate_before" />}
                  fullWidth
                >
                  Prev
                </Button>
                <Button
                  variant="outlined"
                  startIcon={<MediaIcon file_format={this.state.file_format} />}
                  href={this.state.src_list[this.state.idx].href}
                  fullWidth
                >
                  Open
                </Button>
                <Button
                  variant="contained"
                  onClick={this.onClickNextButton}
                  endIcon={<Icon icon="navigate_next" />}
                  fullWidth
                >
                  Next
                </Button>
              </Stack>
            </CardContent>
          </Card>
        )
      }
    }

    const MyApp = (props) => {
      const { Card, Stack, Container, createTheme, ThemeProvider, CssBaseline, Button } = MaterialUI
      const [theme, setTheme] = React.useState(
        createTheme({
          palette: {
            mode: 'dark',
          },
        })
      );

      const toggleTheme = (theme) => {
        if (theme.palette.mode === 'dark') {
          setTheme(
            createTheme({
              palette: {
                mode: 'light',
              },
            })
          )
        } else {
          setTheme(
            createTheme({
              palette: {
                mode: 'dark',
              },
            })
          )
        }
      }

      const str_html = `{files}`
      const dom_parser = new DOMParser();
      const file_doc = dom_parser.parseFromString(str_html, 'text/html');
      const src_list = Array.from(file_doc.querySelectorAll('a'));
      console.debug(src_list);

      const sources = src_list.map((a) => (
        {
          title: a.title,
          href: a.href,
          size: a.querySelector('.size').innerText,
          name: a.querySelector('.name').innerText,
          date: a.querySelector('.date').innerText,
          dirname: parsePath(a.href).dirname,
          file_format: parsePath(a.href).file_format
        }
      ));

      const sorted_sources = sources.sort((a, b) => {
        const a1 = parseInt(a.title.replace(/[^0-9]/g, ''), 10);
        const b1 = parseInt(b.title.replace(/[^0-9]/g, ''), 10);
        const a2 = (a1 !== a1) ? 0 : a1;
        const b2 = (b1 !== b1) ? 0 : b1;

        if (a2 > b2) {
          return 1;
        } else if (a2 < b2) {
          return -1;
        }
        return a.title < b.title
      });
      console.debug(sorted_sources);


      return (
        <ThemeProvider theme={theme}>
          <CssBaseline />
          <Container>
            <PreviewCard sources={sorted_sources} />
            <FilesCard sources={sorted_sources} />
            <Button
              startIcon={theme.palette.mode === 'dark' ? <Icon icon="brightness_7" /> : <Icon icon="brightness_4" />}
              variant="outlined"
              color="secondary"
              onClick={() => toggleTheme(theme)}
              fullWidth
            >
              {theme.palette.mode} mode
            </Button>
          </Container>
        </ThemeProvider>
      )
    }



    ReactDOM.render(
      <MyApp />,
      document.querySelector('.myapp'),
    )
  </script>
</body>

</html>